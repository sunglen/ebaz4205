
		TOPPERS/ASP3カーネル
		ZYBO依存部 ユーザーズマニュアル

		対応バージョン: Release 3.4
		最終更新: 2019年09月30日

このドキュメントは，TOPPERS/ASP3カーネルのZYBOターゲット依存部を使用す
るために必要な事項を説明するものである．

----------------------------------------------------------------------
 TOPPERS/ASP Kernel
     Toyohashi Open Platform for Embedded Real-Time Systems/
     Advanced Standard Profile Kernel

 Copyright (C) 2008-2019 by Embedded and Real-Time Systems Laboratory
             Graduate School of Information Science, Nagoya Univ., JAPAN
 
 上記著作権者は，以下の(1)〜(4)の条件を満たす場合に限り，本ソフトウェ
 ア（本ソフトウェアを改変したものを含む．以下同じ）を使用・複製・改
 変・再配布（以下，利用と呼ぶ）することを無償で許諾する．
 (1) 本ソフトウェアをソースコードの形で利用する場合には，上記の著作
     権表示，この利用条件および下記の無保証規定が，そのままの形でソー
     スコード中に含まれていること．
 (2) 本ソフトウェアを，ライブラリ形式など，他のソフトウェア開発に使
     用できる形で再配布する場合には，再配布に伴うドキュメント（利用
     者マニュアルなど）に，上記の著作権表示，この利用条件および下記
     の無保証規定を掲載すること．
 (3) 本ソフトウェアを，機器に組み込むなど，他のソフトウェア開発に使
     用できない形で再配布する場合には，次のいずれかの条件を満たすこ
     と．
   (a) 再配布に伴うドキュメント（利用者マニュアルなど）に，上記の著
       作権表示，この利用条件および下記の無保証規定を掲載すること．
   (b) 再配布の形態を，別に定める方法によって，TOPPERSプロジェクトに
       報告すること．
 (4) 本ソフトウェアの利用により直接的または間接的に生じるいかなる損
     害からも，上記著作権者およびTOPPERSプロジェクトを免責すること．
     また，本ソフトウェアのユーザまたはエンドユーザからのいかなる理
     由に基づく請求からも，上記著作権者およびTOPPERSプロジェクトを
     免責すること．
 
 本ソフトウェアは，無保証で提供されているものである．上記著作権者お
 よびTOPPERSプロジェクトは，本ソフトウェアに関して，特定の使用目的
 に対する適合性も含めて，いかなる保証も行わない．また，本ソフトウェ
 アの利用により直接的または間接的に生じたいかなる損害に関しても，そ
 の責任を負わない．
 
 $Id: target_user.txt 1264 2019-09-30 03:01:49Z ertl-honda $
----------------------------------------------------------------------

○目次

１．ZYBOターゲット依存部の概要
	1.1 対応するターゲットシステムとターゲット略称
	1.2 ターゲット依存部の構成
	1.3 依存している個別パッケージのバージョン番号
	1.4 開発環境と動作確認条件
	1.5 メモリマップ
２．ターゲット定義事項の規定
	2.1 割込み優先度と割込み番号
	2.2 オーバランハンドラ機能拡張のサポートに関する規定
３．ドライバ関連の情報
	3.1 タイマドライバ
	3.2 シリアルインタフェースドライバ
	3.3 システムログの低レベル出力
４．システム構築手順と実行手順
	4.1 システム構築
	4.2 デバッガの使用方法
５．リファレンス
	5.1 ディレクトリ構成・ファイル構成
	5.2 バージョン履歴


１．ZYBO_Z7ターゲット依存部の概要

ZYBO_Z7ターゲット依存部（GNU開発環境向け）は，TOPPERS/ASP3カーネルを，
Xilinx社のZynq-7000（Cortex-A9）を搭載したZYBO Z7 10/20ボード上で動作
させる環境を構築するためのものである．

また，実ターゲットシステムに代えて，Qemuを用いて実行することもできる．
Qemuで実行する場合には，コンパイルオプションに「-DTOPPERS_USE_QEMU」を
追加する必要がある．

1.1 対応するターゲットシステムとターゲット略称

ZYBO_Z7ターゲット依存部の動作確認は，実機（Degilent ZYBO Z7-10 
Zynq-7000 ARM/FPGA SoC Trainer Board）を用いて行っている．ZYBO Z7に関
する情報は，以下のウェブサイトにある．

	https://japan.xilinx.com/products/boards-and-kits/1-4azfte.html
	
また，Qemu上でも動作確認を行っている．動作確認を行ったQemuのバージョン
は次の通り（このバージョンは，マルチコアでは動作しないので注意）．

	qemu-system-arm		version 2.7.0

Qemu上で実行するためのコマンドは次の通り．

	qemu-system-arm -M xilinx-zynq-a9 -semihosting -m 512M \
					-serial null -serial mon:stdio -nographic -kernel asp

ターゲット略称等は次の通り．

	ターゲット略称：zybo_z7_gcc
	システム略称：zybo_z7
	開発環境略称：gcc

1.2 ターゲット依存部の構成

ZYBO_Z7ターゲット依存部（GNU開発環境向け）は，チップ依存部として
Zynq7000チップ依存部（GNU開発環境向け）を，コア依存部としてARMコア依存
部（GNU開発環境向け）を使用している．

	target/
		zybo_z7_gcc/			ZYBO_Z7ターゲット依存部

	arch/
		arm_gcc/common/		ARMコア依存部
		arm_gcc/zynq7000/	Zynq-7000チップ依存部
		arm_gcc/doc/		ARM依存部に関するドキュメント
		gcc/				GCC開発環境依存部

1.3 依存している個別パッケージのバージョン番号

ZYBO_Z7ターゲット依存部（バージョン 3.4.0）の個別パッケージが依存している
個別パッケージと，動作確認を行ったバージョンは次の通り．

	個別パッケージの名称	バージョン	個別パッケージファイル名
	------------------------------------------------------------------
	ターゲット非依存部		3.4.0		asp3-3.4.0.tar.gz

1.4 開発環境と動作確認条件

開発環境として，以下のURLからプリビルド版をダウンロードすることができ
るGNU ARM Embedded Toolchainを用いている（Cortex-MとCortex-R向けの開発
環境であるが，Cortex-A向けにも使用できる）．

	https://developer.arm.com/open-source/gnu-toolchain/gnu-rm

動作確認を行ったバージョンは次の通り．

	gcc: 7.3.1 20180622
	binutils（objcopy，objdump）：2.30.0.20180329

また，Xilinx社のSDKに付属のコンパイラとIDEを用いることもできる．

	https://japan.xilinx.com/products/design-tools/embedded-software/sdk.html

動作確認を行ったバージョンは次の通り．

	Xilinx SDK 2018.2

Xilinx SDK の IDE を使用するには，新規ワークスペースを作成して，
xilinx_sdk ディレクトリ内のファイルをインポートすればよい．詳細は，
xiinx_sdk 内のREADME.txtを参照のこと．


1.5 メモリマップ

以下のメモリマップを想定している．

	0x00000000 - 0x1fffffff：外付けDDR（512MB）… 最初の1MBは使用しない
	0x40000000 - 0xbfffffff：プログラマブルロジック領域
	0xe0000000 - 0xfdffffff：周辺デバイス等
	0xfffc0000 - 0xffffffff：オンチップメモリ（OCM）領域

外付けDDRの先頭の1MBは使用せず，プログラムを0x00100000番地からダウンロー
ドする設定としている．

メモリマップを変更する場合には，target_kernel_impl.cとzybo_z7.ldを修正す
る必要がある．


２．ターゲット定義事項の規定

ZYBO_Z7ターゲット依存部は，ARMコア依存部とZynq7000チップ依存部を用いて実
装されている．ARMコア依存部およびZynq7000依存部におけるターゲット定義
事項の規定については，「ARM依存部 ユーザーズマニュアル」及び「Zynq7000
チップ依存部 ユーザーズマニュアル」を参照すること．


３．ドライバ関連の情報

3.1 タイマドライバ

高分解能タイマは，MPCoreのグローバルタイマを用いて実現している．また，
MPCoreのウォッチドッグを用いて，オーバランタイマを実現している．

3.2 シリアルインタフェースドライバ

シリアルインタフェースドライバでは，Zynq-7000が内蔵する2つのUARTポート
をサポートしている．

ZYBO_Z7でUSB経由で接続できるポートは，UART1である．サンプルプログラム
（sample1.cdl）では，ログタスクおよびサンプルプログラムが使うポートが
ポート1となっているため，ポート1をUART1に，ポート2をUART0に対応させて
いる．この対応を変更するには，tSIOPortZybo.cdlを修正する必要がある．

各ポートは，以下の通りに設定している．

	ボーレート：115200bps
	データ：8ビット
	パリティ：なし
	ストップビット：1ビット

この設定は，Zynq7000チップ依存部で行っているが，tSIOPortZybo.cdlを修正
することで変更することができる．

3.3 システムログの低レベル出力

システムログの低レベル出力は，シリアルインタフェースドライバが用いてい
るのと同じUARTを用い，ポーリングにより文字を出力する方法で実現している．

用いるSIOポートを変更する場合には，target.cdlを修正する必要がある．


４．システム構築手順と実行手順

4.1 システム構築

ZYBO_Z7用のASP3カーネルを構築する手順は，「TOPPERS/ASP3カーネル ユーザー
ズマニュアル」の「３．クイックスタートガイド」の章に記述されている通り
である．

Xilinx SDKでビルドする場合は，ワークスペースを作成し，zybo_z7_sdkフォルダ
にあるプロジェクトをインポートすることで，サンプルプログラムがビルド可
能である．


５．リファレンス

5.1 ディレクトリ構成・ファイル構成

	target/zybo_z7_gcc/
		E_PACKAGE				簡易パッケージのファイルリスト
		MANIFEST				個別パッケージのファイルリスト
		Makefile.target			Makefileのターゲット依存部
		target.cdl				コンポーネント記述ファイルのターゲット依存部
		target_cfg1_out.h		cfg1_out.cのリンクに必要なスタブの定義
		target_check.trb		kernel_check.trbのターゲット依存部
		target_kernel.cfg		カーネル実装のコンフィギュレーションファイル
		target_kernel.h			kernel.hのターゲット依存部
		target_kernel.trb		kernel.trbのターゲット依存部
		target_kernel_impl.c	カーネル実装のターゲット依存部
		target_kernel_impl.h	カーネル実装のターゲット依存部に関する定義
		target_rename.def		ターゲット依存部の内部識別名のリネーム定義
		target_rename.h			ターゲット依存部の内部識別名のリネーム
		target_sil.h			sil.hのターゲット依存部
		target_stddef.h			t_stddef.hのターゲット依存部
		target_syssvc.h			システムサービスのターゲット依存定義
		target_test.h			テストプログラムのターゲット依存定義
		target_timer.cfg		タイマドライバのコンフィギュレーションファイル
		target_timer.h			タイマドライバを使用するための定義
		target_unrename.h		ターゲット依存部の内部識別名のリネーム解除
		target_user.txt			ターゲット依存部のユーザーズマニュアル
		tSIOPortZybo.cdl		シリアルインタフェースドライバのターゲット
								依存部（ZYBO_Z7用）のコンポーネント記述
		zybo_z7.h					ターゲットのハードウェア資源の定義
		zybo_z7.ld					標準のリンカスクリプト
		xilinx_sdk				Xilinx SDK 用のプロジェクトファイル

5.2 バージョン履歴

2019/09/30
	ZYBO Z7 対応．

2019/03/25
	Release	3.4.0 追従
 
以上
