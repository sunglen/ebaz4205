
		TOPPERS/HRMP3カーネル
		変更履歴

		対応バージョン: Release 3.1.2
		最終更新: 2020年11月3日

このドキュメントは，TOPPERS/HRMP3カーネルの変更履歴を，新しい方から順
に記述したものである．

----------------------------------------------------------------------
 TOPPERS/HRMP Kernel
     Toyohashi Open Platform for Embedded Real-Time Systems/
     High Reliable Multiprocessing Profile Kernel

 Copyright (C) 2019,2020 by Embedded and Real-Time Systems Laboratory
             Graduate School of Information Science, Nagoya Univ., JAPAN
 
 上記著作権者は，以下の(1)〜(4)の条件を満たす場合に限り，本ソフトウェ
 ア（本ソフトウェアを改変したものを含む．以下同じ）を使用・複製・改
 変・再配布（以下，利用と呼ぶ）することを無償で許諾する．
 (1) 本ソフトウェアをソースコードの形で利用する場合には，上記の著作
     権表示，この利用条件および下記の無保証規定が，そのままの形でソー
     スコード中に含まれていること．
 (2) 本ソフトウェアを，ライブラリ形式など，他のソフトウェア開発に使
     用できる形で再配布する場合には，再配布に伴うドキュメント（利用
     者マニュアルなど）に，上記の著作権表示，この利用条件および下記
     の無保証規定を掲載すること．
 (3) 本ソフトウェアを，機器に組み込むなど，他のソフトウェア開発に使
     用できない形で再配布する場合には，次のいずれかの条件を満たすこ
     と．
   (a) 再配布に伴うドキュメント（利用者マニュアルなど）に，上記の著
       作権表示，この利用条件および下記の無保証規定を掲載すること．
   (b) 再配布の形態を，別に定める方法によって，TOPPERSプロジェクトに
       報告すること．
 (4) 本ソフトウェアの利用により直接的または間接的に生じるいかなる損
     害からも，上記著作権者およびTOPPERSプロジェクトを免責すること．
     また，本ソフトウェアのユーザまたはエンドユーザからのいかなる理
     由に基づく請求からも，上記著作権者およびTOPPERSプロジェクトを
     免責すること．
 
 本ソフトウェアは，無保証で提供されているものである．上記著作権者お
 よびTOPPERSプロジェクトは，本ソフトウェアに関して，特定の使用目的
 に対する適合性も含めて，いかなる保証も行わない．また，本ソフトウェ
 アの利用により直接的または間接的に生じたいかなる損害に関しても，そ
 の責任を負わない．
 
 $Id: version.txt 846 2020-11-03 09:55:36Z ertl-hiro $
----------------------------------------------------------------------

		TOPPERS/HRMP3カーネル
		Release 3.1.1 から 3.1.2 への主な変更点

○変更点のリスト

●不具合修正

・メッセージバッファ機能の不具合の修正
	- 待ち情報ブロックへの書き込みを，p_schedtskを書き換える前に行うよ
	  うに修正．

・メモリバリア操作の追加
	- 他プロセッサのp_schedtskを書き換える前に，メモリバリア操作を行う
	  ように修正．

・高分解能タイマ設定ハンドラの修正
	- set_hrt_event_handlerからset_hrt_eventを呼び出す時に，排他制御を
	  行うように修正．

・メモリオブジェクトが持つ情報から「属するクラス」を削除
	- メモリオブジェクトの登録時に，属するクラスを設定しないように変更．
	- ショート定数データ領域をROMリージョンに置くとみなす条件の変更．
	- ATT_MEMをクラスの囲みの中に記述するとエラーとなるように変更．
	- テストプログラムの変更．

・カーネル動作状態フラグが初期化されない不具合の修正
	- カーネル動作状態フラグを，PCBのフィールドから，独立した配列に変
	  更し，クラス共通のbssセクションに配置するように変更．
	- テスト結果期待値の変更．

・静的APIテーブル（kernel_api.def）の不具合修正
	- DEF_SVCのfncdパラメータの型を符号付き整数に修正．
	- fncdが負の場合のテストを追加（pass2_obj3.cfg）．

・コンフィギュレータの修正
	- 手動メモリ配置の場合に，ATT_MODまたはATT_SECを用いた場合を警告
	  とするように修正（前の修正の取り消し）．
	- テスト結果期待値の変更．

・log_extsvc_enter/leaveの記述漏れの修正
	- ターゲット非依存部のリネーム記述に追加．

・ARMコア依存部，チップ依存部，ターゲット依存部の不具合修正
	- T_EXCINF型のintpriフィールドを符号付き整数に修正．

●実装改善

・ARMコア依存部，チップ依存部，ターゲット依存部，ダミーのターゲット依
  存部（target/dummy_gcc）の実装改善
	- プロセッサ間割込みの優先度の記述方法を改善．

●その他（テストプログラム，サンプルプログラム等）

・ダミーのターゲット依存部（target/dummy_gcc）の変更
	- トレースログ関数のリネーム記述を削除．

・テストプログラムの修正
	- タイムウィンドウ通知に関するテスト(1)（test_twdnfy1）内のタイミ
	  ング依存のチェック処理を削除．

・configureとutils/makerelease.rbの変更
	- shellライブラリを使用しないように変更（ruby 2.7.0以降で，標準ラ
	  イブラリに含まれなくなったため）．

・バージョン番号の更新
	- カーネルのバージョン番号を更新．

○ターゲット依存部の要修正箇所（3.1.1 → 3.1.2）

(1) メモリバリア操作の追加
	- memory_barrier関数の定義を追加する．

(2) プロセッサ間割込みの優先度
	- プロセッサ間割込みの優先度の決め方を見直す．

----------------------------------------------------------------------

		TOPPERS/HRMP3カーネル
		Release 3.1.0 から 3.1.1 への主な変更点

○変更点のリスト

●機能拡張

・[ARM依存部] 割込みハンドラのバイパス機能の追加
	- USE_BYPASS_IPI_DISPATCH_HANDERを定義すると，他コアからのディスパッ
	  チ要求割込み受付時に割込みハンドラを呼び出さず，割込み処理を終了
	  させるように変更．

●不具合修正

・タスクコンテキストからシステム周期／タイムウィンドウの実行開始処理を
　行う場合の問題を修正
	- タスクから呼ばれたサービスコールから，システム周期およびタイムウィ
	  ンドウの実行開始処理を行う場合に，CPUロック状態を解除するタイミ
	  ングでタスク切換えが起こることを防ぐために，割込み優先度マスクを，
	  システム周期／タイムウィンドウ切換え割込みの割込み優先度に設定す
	  るように修正．
	- また，実行中の保護ドメインをカーネルドメインに設定するように修正．
	- wait_tmout，wait_tmout_okが，タスクコンテキストから呼ばれても問
	  題ないように修正．
	- [ダミーターゲット依存部] INTPRI_TIMERの定義を追加．

・通知ハンドラ名の衝突の問題の修正
	- タイムウィンドウ通知の通知ハンドラの関数名が，プロセッサ間で衝突
	  する問題と，周期通知やアラーム通知と衝突する可能性がある問題を修
	  正．

・ディスパッチ保留状態でタスク切換えが起こる不具合の修正
	- dis_dspとchg_ipm内で，ジャイアントロックを取得した後に，タスク切
	  換えが必要であればディスパッチを行うように修正．

・trcv_dtqの条件文の修正
	- trcv_dtqで，タスク終了要求のチェックの後のif文に，elseが抜けてい
	  た不具合を修正．

・rot_rdqが非タスクコンテキストから呼ばれた場合の処理の修正
	- rot_rdqが非タスクコンテキストから呼ばれた場合にも，実行状態のタ
	  スクが属するスケジュール単位を操作対象としていた不具合を修正．

・get_tstの実行状態の判定文の修正
	- get_tstで，対象タスクが実行状態であるかの判定文が誤っていた不具
	  合を修正．

・p_my_pcb->p_locspnの初期化箇所の修正
	- p_my_pcb->p_locspnの初期化処理を，initialize_spin_lockから
	  sta_kerに移動．このフィールドは，スピンロックを使用しない場合で
	  も，unl_cpu内で参照されるため．

・xsns_dpnの不具合修正
	- タスクコンテキストから呼び出された場合は，trueを返すように修正．

・get_my_pcbの定義の修正
	- get_my_pcbのデフォルトの定義を，kernel_cfg.c中に生成される割込み
	  ハンドラから呼び出されるのに対応できるように修正．

・コンフィギュレータの不具合修正
	- 保護ドメイン初期化ブロック中のタイムイベントヒープへのリンクが正
	  しく出力されない場合がある不具合の修正．
	- 変数のインクリメントによる通知における変数のアクセス許可に関する
	  エラーチェックの不具合を修正．
	- パス4の終了処理ルーチンに関するチェックの不具合を修正．
	- クラスの指定値が有効範囲外の場合に，エラーメッセージを出力した後，
	  コンフィギュレータがエラーで落ちる不具合を修正．
	- ユーザスタック領域の参照操作に対するアクセス許可パターンが，タス
	  クと同じ値に設定されない不具合を修正．
	- ユーザタスクの生成で，sstkを記述し，sstkszの記述を省略した場合に，
	  エラーメッセージを出力した後，コンフィギュレータがエラーで落ちる
	  不具合を修正．
	- 手動メモリ配置で，stkをNULLとした場合に，エラーメッセージを出力
	  した後，コンフィギュレータがエラーで落ちる不具合を修正．
	- カーネルドメインに属する固定長メモリプールが，アクセス許可ベクタ
	  がデフォルトの値になっているかどうかの判定ができず，手動メモリ配
	  置の場合に検出されないエラーがある不具合を修正．
	- ユーザスタック領域および固定長メモリプール領域用のセクションを
	  ATT_SECした場合をエラーとする．
	- DEF_SRGで，指定したメモリリージョンが未登録の場合に，エラーメッ
	  セージを出力した後，コンフィギュレータがエラーで落ちる不具合を修
	  正．
	- システム周期が設定されていない場合に，CRE_SOMとATT_TWDを記述する
	  と，警告メッセージを出力した後，コンフィギュレータがエラーで落ち
	  る不具合を修正．
	- DEF_ICSに関するエラーメッセージのパラメータが書き換わらないよう
	  に修正．
	- 手動メモリ配置の場合に，ATT_MODまたはATT_SECを用いた場合をエラー
	  とするように修正（警告になっていた）．
	- メモリオブジェクトが1つも登録されていない場合に，コンフィギュレー
	  タがエラーで落ちる不具合を修正．
	- エラーメッセージの修正（"must be with a class" → "must be
	  within a class"）
	- エラーメッセージの修正（"any kernel memory object" → "any
	  memory object"）

・USE_LATERPASS_DOMINIBを用いた時の不具合の修正
	- ドメイン初期化ブロックから参照する変数の宣言を，kernel_mem.cに生
	  成するように修正．
	- $schedcbList，$sdomain，$twdMap，$schedcbMap，$tmevtCountを，
	  $globalVarsに追加．
	- スケジューリング単位管理ブロックとタイムイベントヒープ領域の
	  static宣言をやめる．

・カーネルのデータ構造を配置するメモリリージョンの追加修正
	- 各オブジェクトの管理領域を該当する標準メモリリージョンに配置する
	  ように変更した際に，いくつかの管理領域等で修正漏れがあったのを追
	  加修正．

・手動メモリ配置用のMakefile（sample/Makefile_mml）の追加

・ARMコア依存部，チップ依存部，ターゲット依存部の不具合修正
	- ARMv7では，SMP有効時にACTLRのFWビットを設定するように修正．
	- ユーザモードからは，システム周期オーバラン例外を要求できないよう
	  に修正．
	- request_dispatch_prc，request_ext_ker，request_set_hrt_eventのパ
	  ラメータの型の誤りを修正．
	- オーバランハンドラを使用する場合のレジスタ保存の抜けを修正．

・ダミーターゲット依存部の不具合修正
	- スタックサイズおよびスタック領域のチェックに関するマクロ定義の不
	  具合を修正．
	- GenerateNativeSpnの定義を追加．
	- request_dispatch_prc，request_ext_ker，request_set_hrt_eventのパ
	  ラメータの型の誤りを修正．

・その他の不具合修正
	- is_mprcマクロのパラメータを()で囲むように修正．
	- msta_cycとmsta_almの出口のログ取得マクロ名の誤りを修正．
	- タスクマイグレーションログの取得漏れを修正．
	- time_event.h中のtmevtb_enqueueとtmevtb_dequeueのパラメータ名の誤
	  りを修正（プロトタイプ宣言なので実害なし）．

●機能改善

・コンフィギュレータのエラーメッセージの改善
	- DEF_SRGで，標準ショートRAMリージョン名の記述を省略した場合に，重
	  複したエラーメッセージが出る問題を修正．

●その他（テストプログラム，サンプルプログラム等）

・コンフィギュレータのテスト（test_cfgディレクトリ）の追加

・ARMコア依存部，チップ依存部，ターゲット依存部の変更
	- MPCoreのグローバルタイマによるtarget_hrt_raise_eventの実装を，直
      接割込みを要求する形に変更．
	- プロセッサ間割込み（カーネル終了要求を除く）の割込み優先度を，最
	  低優先度に変更．

・ダミーのターゲット依存部（target/dummy_gcc）の変更
	- カーネル管理外の割込みに対応．
	- カーネル管理／カーネル管理外に固定の割込み番号／割込みハンドラ番
	  号を設定．
	- 割込みハンドラとCPU例外ハンドラの先頭番地のチェックを追加．

・サンプルプログラムの修正
	- サンプルプログラムを，CPUEXC1の定義を参照しないように修正．
	- [ダミーターゲット依存部] サンプルプログラムがビルドできるように
	  修正．

・テストプログラムの修正
	- 通知処理のテスト(1)（test_notify1）の変数の型の誤り（intptr_tと
	  int_tのサイズが異なる場合に不具合が発生）を修正．
	- マルチプロセッサ対応のアラーム通知のテスト(2)（test_malarm2）が
	  意図通りのテストになっていなかったのを修正．

・テストプログラムの改善・変更
	- セマフォ機能のテスト(1)（test_sem1），スピンロック機能のテスト
	  (2)（test_spinlock2），過渡的な状態のテスト(2)（test_mtrans2）の
	  テスト項目を追加．
	- タイムウィンドウ通知に関するテスト（test_twdnfy）をtest_twdnfy1
	  にリネームし，テスト内容を改善．
	- タイムウィンドウ通知に関するテスト(2)（test_twdnfy2）を追加．
	- 過渡的な状態のテスト(5)（test_mtrans5）を追加．

・バージョン番号の更新
	- カーネルのバージョン番号を更新．

○ターゲット依存部の要修正箇所（3.1.0 → 3.1.1）

(1) タイムウィンドウ切換え割込みの割込み優先度
	- 高分解能タイマ割込みの割込み優先度（タイムウィンドウ切換え割込み
	  の割込み優先度と一致していなければならない）を，INTPRI_TIMERの名
	  称で参照できるようにする．

----------------------------------------------------------------------

		TOPPERS/HRMP3カーネル
		Release 3.0.0 から 3.1.0 への主な変更点

○変更点のリスト

●仕様変更，機能拡張

・設定できる最高のタスク優先度の機能の廃止
	- LMT_DOMを廃止．保護ドメイン初期化ブロックを変更．
	- 関連するエラーチェックを削除．
	- 保護ドメインに対する制限に関するテスト（test_lmtdom1，
	  test_lmtdom2）を廃止．

・カーネルのデータ構造を配置するメモリリージョン
	- 各オブジェクトの管理ブロックや管理領域，プロセッサ毎に必要なカー
	  ネルのデータ構造を，該当する標準メモリリージョンに配置するように
	  変更．
	- [ARMコア依存部] それらを配置するセクション（.kernel_data_<クラス
	  名>）を設ける．

・システム周期とタイムウィンドウの開始のトレースログ
	- カーネルのコードに，トレースログを取るためのマクロを追加．

・高分解能タイマが64ビットの場合に対応
	- t_stddef.hにおけるHRTCNT型の定義を変更．
	- set_hrt_eventにおいて，タイムイベントヒープが空の場合と，高分解
	  能タイマに指定する相対カウント値がHRTCNT_BOUNDよりも大きい場合の
	  処理を変更．マクロ定義のチェックを追加．
	- fch_hrtのソフトウェア割込みによる呼出し方法を変更．
	- MPCore内蔵タイマ用のタイマドライバを，高分解能タイマを64ビットに
	  できるように拡張．

・コンフィギュレータの仕様変更
	- 静的APIの後に";"がない場合はエラーとするように変更．

・ARMコア依存部，チップ依存部，ターゲット依存部の仕様変更
	- フェイタルデータアボートをエミュレートされたCPU例外と位置付け，
	  CPU例外ハンドラ番号を割り付けた．

・ダミーのターゲット依存部（target/dummy_gcc）を追加

●不具合修正

・trcv_dtqでrelease_glockを2回呼ぶパスがある不具合を修正

・mrot_rdqの不具合を修正
	- mrot_rdqを拡張サービスコールから呼び出した場合に，TDOM_SELFが，
	  拡張サービスコールを呼び出したタスクが属する保護ドメインになって
	  いた不具合を修正．

・initialize_interrupt内で使用する変数の誤りを修正

・アイドルスタックを置くセクションの修正
	- 各プロセッサのアイドルスタックを置くセクションを，クラスのリスト
	  から初期割付けプロセッサが一致するものをサーチして決定するように
	  修正．

・不要なスケジューリング単位管理ブロックを生成しないように修正
	- 不要なスケジューリング単位管理ブロックの生成を抑止するための条件
	  判定を追加．

・その他の不具合修正
	- 不要なextern宣言（set_my_hrt_event）の削除．
	- リネーム記述（kernel_rename.def等）の修正．
	- 静的APIの最後に";"が抜けている不具合の修正．

●実装改善

・システム周期の切換え遅れへの対応
	- あるプロセッサで，システム周期の切換えが大きく遅れた場合に，予期
	  できない振る舞いにならないように実装を改善．

・ターゲット拡大対応のための修正
	- kernel_opt.trbとkernel_mem.trbにおいて，USE_LATERPASS_DOMINIBの
	  場合に，GenerateDominibを呼ぶ処理を後に移動．
	- メモリオブジェクトの先頭／終了ラベルの宣言を，ターゲット依存部で
	  変更可能に．

・rot_rdq中の不要なif文を削除

・ARMコア依存部，チップ依存部，ターゲット依存部の実装改善
	- core_test.hにおけるCPU例外の発生コードを見直し．
	- ARM依存のテストプログラム（arm_cpuexc）を追加．
	- software_term_hookを，target_exitから呼ぶように変更．

・その他の実装改善
	- VALID_TMOUTの定義を変更．
	- check_adjtimのパラメータの型と，エラーチェックの条件式を変更．
	- TOPPERS_ISTKPTが定義されていない時に，idstk_tableを生成するよう
	  に変更．
	- プロセッサ毎に必要なカーネルのデータ領域の配置場所を，そのプロセッ
	  サが初期割付けプロセッサであるようなクラスがない時は，クラス共通
	  の標準メモリリージョンにするように変更．
	- syssvcディレクトリにあるシステムコンフィギュレーションファイル中
	  のATT_MODを，「#ifdef TOPPERS_SUPPORT_ATT_MOD」「#endif」で囲む．

●その他（テストプログラム，サンプルプログラム等）

・configureとsample/Makefileの修正
	- configureへのオプションで，ライブラリのリンク記述を追加できるよ
	  うに，configureとsample/Makefileを修正．

・サンプルプログラムの拡張
	- サンプルプログラム(1)（sample1）を，2つのプロセッサを動作させる
	  ように拡張．

・テストプログラムの追加
	- システム周期の切換えが遅れた場合のテスト（test_mdelay1）を追加．
	- システム状態管理機能のテスト(2)（test_sysman2）を追加．
	- [ARM依存部] ARM向けFPUのテスト(1)（arm_fpu1）を追加．

・テストプログラムの変更
	- test_tprot1〜test_tprot4を，test_common.hを使うように変更．

・その他の変更
	- gentest.rbに，ローカル変数を定義する機能を追加．

・ドキュメントの充実，コメントの修正

・バージョン番号の更新
	- カーネルとカーネル仕様のバージョン番号を更新．

○ターゲット依存部の要修正箇所（3.0.0 → 3.1.0）

(1) パス2の生成スクリプトのターゲット依存部の仕様変更への対応
	- DefineVariableSectionの定義を追加する．
	- SecnameKernelDataの定義を追加する．
	- SecnameSystemStackを，clsに$TCLS_NONEが渡された場合に対応できる
	  ように修正する．
	- 各クラスのカーネルのデータ領域のセクションを，ATT_SECで登録でき
	  ないセクション名の定義に追加し，カーネルドメインに登録する．
	- AllocSystemStackとAllocUserMempfixが，kernel.trbで定義されている
	  デフォルトで良い場合には，定義を削除する．
	- TargetGenPCB，TargetGenIDSTACKを削除．

(2) 高分解能タイマが64ビットの場合に対応（オプション）
	- 高分解能タイマを64ビットにできる場合には，必要に応じて対応する．
	  具体的には，ASP3カーネルのポーティングガイドの(3-8-1)，(5-3-1)，
	  (6-13-2-5)の設定に対応し，tool_svc.hのターゲット依存部に，
	  CAL_SVC_0M_R_UINT64の定義を追加する．

(3) [ARM依存部] software_term_hookの呼び出し箇所変更への対応
	- 必要であれば，target_exitにsoftware_term_hookを呼ぶ処理を追加す
	  る．

----------------------------------------------------------------------
